<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fish of Fortune – Lane Catcher</title>
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: radial-gradient(circle at top, #77d7ff 0%, #35a9ff 35%, #0c2e6a 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #game-container {
      position: relative;
      width: 600px;
      height: 900px;
      max-width: 90vw;
      max-height: 95vh;
      border-radius: 32px;
      overflow: hidden;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
      background: rgba(0, 0, 0, 0.25);
    }

    @media (max-width: 700px) {
      #game-container {
        width: 90vw;
        height: calc(90vw * 1.5);
      }
    }

    @media (max-height: 950px) {
      #game-container {
        height: 95vh;
        width: calc(95vh / 1.5);
      }
    }

    #gameCanvas {
      display: block;
      width: 100%;
      height: 100%;
      border-radius: 32px;
      background: transparent;
    }

    #hud {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 88%;
      padding: 6px 16px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      color: #333;
      z-index: 5;
      backdrop-filter: blur(6px);
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 9px;
      font-size: 27px;
    }

    .icon {
      font-size: 27px;
    }

    .icon-heart {
      color: #ff4a70;
    }

    #footer-hint {
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      text-align: center;
      font-size: 16.5px;
      color: rgba(255, 255, 255, 0.88);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
      z-index: 5;
    }

    .screen {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .screen-content {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding-bottom: 0;
      flex-direction: column;
      height: 100%;
    }

    .start-screen {
      display: flex;
      align-items: center;
      background-image: url("assets/start_bg.png");
      background-size: cover;
      background-position: center;
      justify-content: center;
    }

    #main-logo {
      width: 80%;
      max-width: 675px;
      height: auto;
      margin-bottom: 20px;
    }

    #start-button {
      margin-top: 20vh;
      width: 70%;
    }

    .btn-img {
      cursor: pointer;
      user-select: none;
      transition: transform 0.2s ease;
      transform: scale(1);
    }

    .btn-img:hover {
      transform: scale(1.1);
    }

    .btn-img:active {
      transform: scale(0.95);
    }

    .popup .btn-img {
      width: 40%;
    }

    #win-popup .btn-img {
      width: 72%;
    }

    #gameover-popup .btn-img {
      width: 60%;
    }

    .popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 99;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease-out, visibility 0.5s;
    }

    .popup-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .popup {
      position: fixed;
      left: 100%;
      top: 50%;
      transform: translate(0, -50%);
      width: 750px;
      max-width: 90vw;
      z-index: 100;
      transition: left 0.5s ease-out, transform 0.5s ease-out;
    }

    .popup.show {
      left: 50%;
      transform: translate(-50%, -50%);
    }

    @media (max-width: 800px) {
      .popup {
        width: 85vw;
      }
    }

    @media (max-width: 600px) {
      .popup {
        width: 90vw;
      }
    }

    .popup-bg {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 20px;
    }

    .popup-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, calc(-50% + 60px));
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    #win-popup .popup-content {
      transform: translate(-50%, calc(-50% + 9.33%));
    }

    #gameover-popup .popup-content {
      transform: translate(-50%, calc(-50% + 10.7%));
      gap: 6.7%;
    }

    .popup-content .btn-img {
      display: block;
      position: relative;
    }

    #win-popup .popup-content .btn-img {
      margin-top: 188px;
    }

    #gameover-popup .popup-content .btn-img {
      margin-top: 80px;
    }

    .final-text {
      font-family: "Luckiest Guy", cursive;
      font-size: 3.7%;
      font-size: clamp(18px, 3.7vw, 28px);
      color: #ffffff;
      text-shadow: 0 3px 6px rgba(0, 0, 0, 0.8);
      white-space: nowrap;
      pointer-events: none;
    }

    #gameover-popup .popup-content .final-text {
      position: relative;
      top: 80px;
    }

    .fish-title {
      font-family: "Luckiest Guy", cursive;
      font-size: 102px;
      text-align: center;
      letter-spacing: 2px;
      background: linear-gradient(#ffe55a, #ff9c00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      -webkit-text-stroke: 9px #7a3f00;
      text-shadow:
        0 6px 0 #703800,
        0 15px 24px rgba(0, 0, 0, 0.45),
        0 0 15px rgba(255, 165, 0, 0.5);
    }
  </style>
</head>

<body>
  <audio id="background-music" src="sounds/background.mp3" loop></audio>
  <audio id="lose-sound" src="sounds/lose.mp3"></audio>
  <audio id="coin-gem-sound" src="sounds/coin-gem.mp3"></audio>
  <audio id="crash-sound" src="sounds/crash.mp3"></audio>
  <audio id="button-sound" src="sounds/button.mp3"></audio>
  <audio id="win-sound" src="sounds/win.mp3"></audio>
  <div id="game-container">
    <canvas id="gameCanvas" width="800" height="1200"></canvas>
    <div id="hud">
      <div class="stat">
        <img src="assets/coin_fish.png" class="icon" style="width: 40.5px; height: 40.5px; object-fit: contain;"
          alt="coins">
        <span id="coins-label">0</span>
      </div>
      <div class="stat">
        <div class="icon icon-heart">♥</div>
        <span id="lives-label">3</span>
      </div>
    </div>
    <div id="start-screen" class="screen start-screen">
      <div class="screen-content">
        <img id="main-logo" src="assets/fishoffortune.png" alt="Fish of Fortune Logo" />
        <img id="start-button" class="btn-img" src="assets/btn_start.png" alt="Start" />
      </div>
    </div>
    <div id="popup-overlay" class="popup-overlay"></div>
    <div id="gameover-popup" class="popup">
      <img src="assets/bg_gameover.png" alt="Game Over" class="popup-bg">
      <div class="popup-content">
        <div class="final-text">
          Final coins: <span id="final-coins">0</span>
        </div>
        <img class="btn-img btn-play-again" src="assets/btn_play_again.png" alt="Play Again">
      </div>
    </div>
    <div id="win-popup" class="popup">
      <img src="assets/bg_youwin.png" alt="You Win" class="popup-bg">
      <div class="popup-content">
        <img class="btn-img btn-play-again" src="assets/btn_play_again.png" alt="Play Again">
      </div>
    </div>
    <div id="footer-hint">
      Move the boat with ◀ ▶ or A / D. Catch coins & gems, avoid starfish!
    </div>
  </div>
  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = "high";
    const coinsLabel = document.getElementById("coins-label");
    const livesLabel = document.getElementById("lives-label");
    const finalCoinsSpan = document.getElementById("final-coins");
    const backgroundMusic = document.getElementById("background-music");
    const loseSound = document.getElementById("lose-sound");
    const coinGemSound = document.getElementById("coin-gem-sound");
    const crashSound = document.getElementById("crash-sound");
    const buttonSound = document.getElementById("button-sound");
    const winSound = document.getElementById("win-sound");
    const startScreen = document.getElementById("start-screen");
    const startButton = document.getElementById("start-button");
    const playAgainButtons = document.querySelectorAll(".btn-play-again");
    const laneCount = 5;
    const laneWidth = canvas.width / laneCount;
    let playerWidth = 333.45;
    let playerHeight = 333.45;
    const BOAT_X_OFFSET = 2.4;
    const baseObjectSize = 82.8;
    const obstacleSize = 115.2;
    const gemSize = 172.5;
    const MIN_SPAWN_DISTANCE = 60;
    let gemWidth = gemSize;
    let gemHeight = gemSize;
    let obstacleWidth = obstacleSize;
    let obstacleHeight = obstacleSize;
    const playerY = canvas.height - playerHeight - 18;
    let playerLane = Math.floor(laneCount / 2);
    let playerLaneSmooth = playerLane;
    const LANE_TRANSITION_SPEED = 0.25;
    let coins = 0;
    let lives = 3;
    let gameRunning = false;
    let fallingObjects = [];
    let lastSpawnBottomYPerLane = Array(laneCount).fill(-Infinity);
    let lastFrameTime = performance.now();
    const TARGET_FPS = 60;
    const FRAME_TIME = 1000 / TARGET_FPS;
    const waterImg = new Image();
    waterImg.src = "assets/water.png";
    let waterLoaded = false;
    waterImg.onload = () => {
      waterLoaded = true;
    };
    let waterOffset = 0;
    let waterDir = 1;
    const WATER_SPEED = 0.18;
    const WATER_VIEW_FRACTION = 0.8;
    const imgPlayer = new Image();
    imgPlayer.src = "assets/boat_player.png";
    imgPlayer.onload = () => {
      const baseSize = 333.45;
      const aspect = imgPlayer.naturalWidth / imgPlayer.naturalHeight;
      if (imgPlayer.naturalWidth >= imgPlayer.naturalHeight) {
        playerWidth = baseSize;
        playerHeight = baseSize / aspect;
      } else {
        playerHeight = baseSize;
        playerWidth = baseSize * aspect;
      }
    };
    const imgCoin = new Image();
    imgCoin.src = "assets/coin_fish.png";
    const imgGem = new Image();
    imgGem.src = "assets/gem_fish.png";
    imgGem.onload = () => {
      const baseSize = gemSize;
      const aspect = imgGem.naturalWidth / imgGem.naturalHeight;
      if (imgGem.naturalWidth >= imgGem.naturalHeight) {
        gemWidth = baseSize;
        gemHeight = baseSize / aspect;
      } else {
        gemHeight = baseSize;
        gemWidth = baseSize * aspect;
      }
    };
    const imgStar = new Image();
    imgStar.src = "assets/star_obstacle.png";
    imgStar.onload = () => {
      const baseSize = obstacleSize;
      const aspect = imgStar.naturalWidth / imgStar.naturalHeight;
      if (imgStar.naturalWidth >= imgStar.naturalHeight) {
        obstacleWidth = baseSize;
        obstacleHeight = baseSize / aspect;
      } else {
        obstacleHeight = baseSize;
        obstacleWidth = baseSize * aspect;
      }
    };
    const OBJECT_TYPES = {
      COIN: { value: 1, kind: "coin" },
      GEM: { value: 10, kind: "gem" },
      OBSTACLE: { value: 0, kind: "star" },
    };
    let boatTime = 0;
    const BOAT_BOB_AMPLITUDE = 12;
    const BOAT_ANGLE_AMPLITUDE = 0.06;
    const BOAT_BOB_SPEED = 0.06;
    function init() {
      coins = 0;
      lives = 3;
      fallingObjects = [];
      playerLane = Math.floor(laneCount / 2);
      playerLaneSmooth = playerLane;
      gameRunning = true;
      boatTime = 0;
      waterOffset = 0;
      waterDir = 1;
      lastFrameTime = performance.now();
      lastSpawnBottomYPerLane = Array(laneCount).fill(-Infinity);
      const gameoverPopup = document.getElementById("gameover-popup");
      const winPopup = document.getElementById("win-popup");
      const overlay = document.getElementById("popup-overlay");
      if (gameoverPopup) gameoverPopup.classList.remove("show");
      if (winPopup) winPopup.classList.remove("show");
      if (overlay) overlay.classList.remove("show");
      if (startScreen) startScreen.style.display = "none";
      updateStats();
    }
    function movePlayer(direction) {
      if (!gameRunning) return;
      if (direction === "left" && playerLane > 0) playerLane--;
      if (direction === "right" && playerLane < laneCount - 1) playerLane++;
    }
    document.addEventListener("keydown", (e) => {
      if (["ArrowLeft", "a", "A"].includes(e.key)) movePlayer("left");
      if (["ArrowRight", "d", "D"].includes(e.key)) movePlayer("right");
    });
    if (startButton) {
      startButton.addEventListener("click", () => {
        if (buttonSound) buttonSound.play().catch(error => console.error("Error playing button sound:", error));
        if (startScreen) startScreen.style.display = "none";
        if (backgroundMusic) backgroundMusic.play().catch(error => console.error("Error playing background music:", error));
        init();
      });
    }
    playAgainButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        if (buttonSound) buttonSound.play().catch(error => console.error("Error playing button sound:", error));
        const gameoverPopup = document.getElementById("gameover-popup");
        const winPopup = document.getElementById("popup-win");
        const overlay = document.getElementById("popup-overlay");
        if (gameoverPopup) gameoverPopup.classList.remove("show");
        if (winPopup) winPopup.classList.remove("show");
        if (overlay) overlay.classList.remove("show");
        if (backgroundMusic) {
          backgroundMusic.currentTime = 0;
          backgroundMusic.play().catch(error => console.error("Error playing background music:", error));
        }
        init();
      });
    });
    function addFallingObject() {
      if (!gameRunning) return;
      const lane = Math.floor(Math.random() * laneCount);
      const rand = Math.random();
      let type;
      if (rand < 0.15) {
        type = OBJECT_TYPES.GEM;
      } else if (rand < 0.65) {
        type = OBJECT_TYPES.COIN;
      } else if (rand < 0.65 + (0.35 * 0.70)) {
        type = OBJECT_TYPES.OBSTACLE;
      } else {
        return;
      }
      let currentWidth, currentHeight;
      if (type === OBJECT_TYPES.GEM) {
        currentWidth = gemWidth;
        currentHeight = gemHeight;
      } else if (type === OBJECT_TYPES.OBSTACLE) {
        currentWidth = obstacleWidth;
        currentHeight = obstacleHeight;
      } else {
        currentWidth = baseObjectSize;
        currentHeight = baseObjectSize;
      }
      const potentialNewObjectTopY = -currentHeight * 0.5;
      const potentialNewObjectBottomY = potentialNewObjectTopY + (currentHeight * 0.5);
      const isOverlap = fallingObjects.some(obj => {
        if (obj.lane !== lane) return false;
        const existingObjectCurrentTopY = obj.y;
        const existingObjectCurrentBottomY = obj.y + obj.height;
        const gap = MIN_SPAWN_DISTANCE;
        return (potentialNewObjectBottomY + gap > existingObjectCurrentTopY && potentialNewObjectTopY < existingObjectCurrentBottomY + gap);
      });
      if (isOverlap) {
        return;
      }
      fallingObjects.push({
        lane,
        y: potentialNewObjectTopY,
        type,
        baseWidth: currentWidth,
        baseHeight: currentHeight,
        width: currentWidth * 0.5,
        height: currentHeight * 0.5,
        speed: 5.0,
        scale: 0.5
      });
    }
    function update(deltaTime) {
      if (!gameRunning) return;
      const normalizedDelta = deltaTime / FRAME_TIME;
      if (waterLoaded && waterImg.width > 0) {
        const texW = waterImg.width;
        const viewW = Math.floor(texW * WATER_VIEW_FRACTION);
        const maxOffset = Math.max(0, texW - viewW);
        waterOffset += waterDir * WATER_SPEED * normalizedDelta;
        if (waterOffset > maxOffset) {
          waterOffset = maxOffset;
          waterDir = -1;
        } else if (waterOffset < 0) {
          waterOffset = 0;
          waterDir = 1;
        }
      }
      boatTime += BOAT_BOB_SPEED * normalizedDelta;
      playerLaneSmooth += (playerLane - playerLaneSmooth) * LANE_TRANSITION_SPEED;
      for (let i = fallingObjects.length - 1; i >= 0; i--) {
        const obj = fallingObjects[i];
        const startScaleY = -obj.baseHeight * 0.5;
        const endScaleY = playerY;
        let currentScale = 0.5;
        if (obj.y > startScaleY && endScaleY > startScaleY) {
          const scaleRange = endScaleY - startScaleY;
          const progress = (obj.y - startScaleY) / scaleRange;
          currentScale = 0.5 + (0.5 * Math.min(1, Math.max(0, progress)));
        } else if (obj.y <= startScaleY) {
          currentScale = 0.5;
        } else {
          currentScale = 1.0;
        }
        obj.width = obj.baseWidth * currentScale;
        obj.height = obj.baseHeight * currentScale;
        obj.scale = currentScale;
        obj.y += obj.speed * normalizedDelta;
        if (obj.y > canvas.height + obj.height) {
          fallingObjects.splice(i, 1);
          continue;
        }
        if (playerLane === obj.lane) {
          const verticalDistance = Math.abs(obj.y - (playerY + playerHeight / 2));
          const collisionRange = (playerHeight + obj.height) / 2;
          if (verticalDistance < collisionRange) {
            if (obj.type.kind === "star") {
              lives--;
              if (crashSound) crashSound.play().catch(error => console.error("Error playing crash sound:", error));
              updateStats();
              if (lives <= 0) gameOver();
            } else {
              coins += obj.type.value;
              if (coinGemSound) coinGemSound.play().catch(error => console.error("Error playing coin/gem sound:", error));
              updateStats();
              if (coins >= 100) gameWin();
            }
            fallingObjects.splice(i, 1);
          }
        }
      }
      if (Math.random() < 0.03) {
        addFallingObject();
      }
    }
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const w = canvas.width;
      const h = canvas.height;
      if (waterLoaded && waterImg.width > 0 && waterImg.height > 0) {
        const texW = waterImg.width;
        const texH = waterImg.height;
        const viewW = Math.floor(texW * WATER_VIEW_FRACTION);
        const srcX = Math.floor(waterOffset);
        const srcY = 0;
        ctx.drawImage(
          waterImg,
          srcX,
          srcY,
          viewW,
          texH,
          0,
          0,
          w,
          h
        );
      } else {
        ctx.fillStyle = "#0066aa";
        ctx.fillRect(0, 0, w, h);
      }
      const basePlayerX =
        playerLaneSmooth * laneWidth +
        (laneWidth - playerWidth) / 2.6 +
        BOAT_X_OFFSET;
      const basePlayerY = playerY;
      const bob = Math.sin(boatTime) * BOAT_BOB_AMPLITUDE;
      const angle = Math.sin(boatTime) * BOAT_ANGLE_AMPLITUDE;
      ctx.save();
      ctx.translate(
        basePlayerX + playerWidth / 2,
        basePlayerY + playerHeight / 2 + bob
      );
      ctx.rotate(angle);
      if (imgPlayer && imgPlayer.naturalWidth) {
        ctx.drawImage(
          imgPlayer,
          -playerWidth / 2,
          -playerHeight / 2,
          playerWidth,
          playerHeight
        );
      }
      ctx.restore();
      for (const obj of fallingObjects) {
        const objX = obj.lane * laneWidth + laneWidth / 2;
        const drawX = objX - obj.width / 2;
        const drawY = obj.y - obj.height / 2;
        let sprite = null;
        if (obj.type.kind === "coin") sprite = imgCoin;
        else if (obj.type.kind === "gem") sprite = imgGem;
        else if (obj.type.kind === "star") sprite = imgStar;
        if (sprite && sprite.naturalWidth) {
          ctx.drawImage(sprite, drawX, drawY, obj.width, obj.height);
        }
      }
    }
    function updateStats() {
      coinsLabel.textContent = coins;
      livesLabel.textContent = lives;
    }
    function gameOver() {
      gameRunning = false;
      finalCoinsSpan.textContent = coins;
      const popup = document.getElementById("gameover-popup");
      const overlay = document.getElementById("popup-overlay");
      if (backgroundMusic) backgroundMusic.pause();
      if (loseSound) loseSound.play();
      if (overlay) overlay.classList.add("show");
      if (popup) {
        popup.classList.add("show");
      }
    }
    function gameWin() {
      gameRunning = false;
      const popup = document.getElementById("win-popup");
      const overlay = document.getElementById("popup-overlay");
      if (backgroundMusic) backgroundMusic.pause();
      if (winSound) winSound.play();
      if (overlay) overlay.classList.add("show");
      if (popup) {
        popup.classList.add("show");
      }
    }
    function gameLoop(currentTime) {
      const deltaTime = currentTime - lastFrameTime;
      lastFrameTime = currentTime;
      update(deltaTime);
      draw();
      requestAnimationFrame(gameLoop);
    }
    updateStats();
    requestAnimationFrame(gameLoop);
  </script>
</body>

</html>